# subqueries using with

# 1
with sales_for_region_by_rep as
         (
             -- total sales by region for rep
             select r.name as region_name, sr.name as rep_name, sum(o.total_amt_usd) total_sales
             from accounts a
                      join orders o on a.id = o.account_id
                      join sales_reps sr on a.sales_rep_id = sr.id
                      join region r on sr.region_id = r.id
             group by 1, 2
             order by 3 desc
         ),
     max_sales_for_region as
         (
             -- max sales by region for rep, rep name removed
             select t1.region_name, max(t1.total_sales) as total_sales
             from (
                      -- sales for region by rep
                      select r.name as region_name, sr.name as rep_name, sum(o.total_amt_usd) total_sales
                      from accounts a
                               join orders o on a.id = o.account_id
                               join sales_reps sr on a.sales_rep_id = sr.id
                               join region r on sr.region_id = r.id
                      group by 1, 2
                  ) as t1
             group by 1
         )
select sales_for_region_by_rep.region_name, sales_for_region_by_rep.rep_name, sales_for_region_by_rep.total_sales
from sales_for_region_by_rep
join max_sales_for_region on sales_for_region_by_rep.region_name = max_sales_for_region.region_name and
                             sales_for_region_by_rep.total_sales = max_sales_for_region.total_sales

